trigger:
  - main

variables:
  azureContainerRegistry: 'bestrong'
  azureResourceGroup: 'pivinter-rg'
  imageRepository: 'bestrong-api'
  tag: '$(Build.BuildId)'
  # Separate connection types for different Azure resources
  dockerRegistryServiceConnection: 'bestrong-acr'  # Docker registry connection
  azureRmServiceConnection: 'azure-conn'           # Azure Resource Manager connection

stages:
# Stage 1: Build & Push Docker Image to ACR
- stage: Build
  jobs:
  - job: BuildAndPush
    pool:
      vmImage: 'ubuntu-latest'
    steps:
    - checkout: self

    - task: Docker@2
      displayName: 'Login to ACR'
      inputs:
        command: login
        containerRegistry: '$(dockerRegistryServiceConnection)' 

    - task: Docker@2
      displayName: 'Build and Push Docker Image'
      inputs:
        containerRegistry: '$(dockerRegistryServiceConnection)'
        repository: '$(imageRepository)'
        command: buildAndPush
        dockerfile: '$(Build.SourcesDirectory)/Dockerfile'
        tags: |
          $(tag)
          latest

# Stage 2: Package & Push Helm Chart to ACR
- stage: Package
  displayName: 'Package Helm Chart'
  jobs:
  - job: PackageHelmChart
    pool:
      vmImage: 'ubuntu-latest'
    steps:
    - checkout: self

    - task: HelmInstaller@1
      inputs:
        helmVersionToInstall: 'latest'

    # Using Helm v3's OCI support instead of deprecated az acr helm commands
    - task: AzureCLI@2
      displayName: 'Push Helm Chart to ACR as OCI artifact'
      inputs:
        azureSubscription: '$(azureRmServiceConnection)'
        scriptType: 'bash'
        scriptLocation: 'inlineScript'
        inlineScript: |
          # Login to ACR using the Azure CLI
          az acr login --name $(azureContainerRegistry)
          
          # Package the Helm chart
          helm package $(Build.SourcesDirectory)/Helm \
            --version $(Build.BuildId) \
            --destination $(Build.ArtifactStagingDirectory)
          
          # Push Helm chart as OCI artifact to ACR
          export HELM_EXPERIMENTAL_OCI=1
          CHART_PATH=$(Build.ArtifactStagingDirectory)/bestrong-$(Build.BuildId).tgz
          
          # Push the chart using Helm's OCI support
          helm push $CHART_PATH oci://$(azureContainerRegistry).azurecr.io/helm

# Stage 3: Deploy to AKS
- stage: Deploy
  displayName: 'Deploy to AKS'
  dependsOn:
    - Build
    - Package
  jobs:
  - deployment: DeployToAKS
    pool:
      vmImage: 'ubuntu-latest'
    environment: 'production'
    strategy:
      runOnce:
        deploy:
          steps:
          - task: HelmInstaller@1
            inputs:
              helmVersionToInstall: 'latest'
              
          - task: AzureCLI@2
            displayName: 'Deploy from ACR to AKS'
            inputs:
              azureSubscription: '$(azureRmServiceConnection)'
              scriptType: 'bash'
              scriptLocation: 'inlineScript'
              inlineScript: |
                # Login to ACR
                az acr login --name $(azureContainerRegistry)
                
                # Set HELM_EXPERIMENTAL_OCI for OCI support
                export HELM_EXPERIMENTAL_OCI=1
                
                # Pull the chart from ACR
                helm pull oci://$(azureContainerRegistry).azurecr.io/helm/bestrong:$(Build.BuildId) --destination $(Agent.TempDirectory)
                
                # Use kubectl to ensure we're connected to the right cluster
                az aks get-credentials -n aks-bestrong -g $(azureResourceGroup)
                
                # Deploy the chart
                helm upgrade --install bestrong-api \
                  $(Agent.TempDirectory)/bestrong-$(Build.BuildId).tgz \
                  --set image.repository=$(azureContainerRegistry).azurecr.io/$(imageRepository) \
                  --set image.tag=$(tag) \
                  --namespace default